<?php
/**
 * Plugin Name: Hockey Sign-in
 * Plugin URI: /wp-content/plugins/hockeysignin
 * Description: A custom sign-in and roster management system for hockey players.
 * Version: 1.0
 * Author: Jason Craig, ChatGPT and Gemini LLM's
 * Author URI: http://halifaxpickuphockey.com
 */


 // Legacy file . From effort to create new tables. 
 
register_activation_hook(__FILE__, 'hockeysignin_activate');
function hockeysignin_activate() {
    global $wpdb;
    $charset_collate = $wpdb->get_charset_collate();
    $tableName = $wpdb->prefix . 'hockeysignin_players';

    $sql = "CREATE TABLE $tableName (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        name tinytext NOT NULL,
        position char(1) NOT NULL,
        active_nights varchar(255) NOT NULL,
        PRIMARY KEY  (id)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}

// This add_action call should be outside of the hockeysignin_activate function
add_action('admin_menu', 'hockeysignin_admin_menu');

function hockeysignin_admin_menu() {
    add_menu_page(
        'Hockey Sign-in', // Page title
        'Hockey Sign-in', // Menu title
        'manage_options', // Capability
        'hockeysignin', // Menu slug
        'hockeysignin_admin_page', // Function to display the page
        'dashicons-admin-generic', // Icon URL
        6 // Position
    );
}

function hockeysignin_admin_page() {
    ob_start(); // Start buffering output
    global $wpdb;
    $table_name = $wpdb->prefix . 'hockeysignin_players';

    // Check if we're deleting a player
    if (isset($_GET['delete'], $_GET['_wpnonce']) && is_numeric($_GET['delete'])) {
        $player_id = intval($_GET['delete']);
        $nonce = $_GET['_wpnonce'];

                // Security check
        if (!wp_verify_nonce($nonce, 'hockeysignin_delete_player_' . $player_id)) {
            die('Security check failed');
        }

        // Capability check
        if (current_user_can('manage_options')) {
            $wpdb->delete($table_name, array('id' => $player_id), array('%d'));
            // Redirect to avoid resubmission
            wp_redirect(admin_url('admin.php?page=hockeysignin'));
            exit;
        } else {
            wp_die('You do not have sufficient permissions to access this page.');
        }
    }

    // Check if we're adding a new player
    if (isset($_POST['submit']) && check_admin_referer('hockeysignin_add_player')) {
        // Check if the necessary POST values are set
        $name = isset($_POST['player_name']) ? sanitize_text_field($_POST['player_name']) : '';
        $position = isset($_POST['player_position']) ? sanitize_text_field($_POST['player_position']) : '';
        $active_nights = isset($_POST['active_nights']) ? implode(',', $_POST['active_nights']) : '';

        // Only proceed if $name and $position are not empty
        if (!empty($name) && !empty($position)) {
            $wpdb->insert(
                $table_name,
                array(
                    'name' => $name,
                    'position' => $position,
                    'active_nights' => $active_nights
                ),
                array('%s', '%s', '%s')
            );

            wp_redirect(admin_url('admin.php?page=hockeysignin'));
            exit;
        }
    }
    
    // Form and table rendering...

    ob_end_flush(); // End buffering and send output to the browser
}
?>
<div class="wrap">
    <h2>Hockey Sign-in Player Management</h2>
    <form method="post" action="">
        <?php wp_nonce_field('hockeysignin_add_player'); ?>
        <table class="form-table">
            <!-- Form fields for adding a new player -->
        </table>
        <input type="submit" name="submit" value="Add Player" class="button-primary"/>
    </form>

    <script type="text/javascript">
    function confirmDelete(id, nonce) {
        var conf = confirm("Are you sure you want to delete this player?");
        if (conf) {
            window.location.href = '<?php echo esc_js(admin_url('admin.php?page=hockeysignin&delete=')); ?>' + id + '&_wpnonce=' + nonce;
        }
    }
    </script>

    <?php
    // Query and display players
    $players = $wpdb->get_results("SELECT * FROM $table_name");
    if ($players) {
        echo '<table class="wp-list-table widefat fixed striped">';
        echo '<thead><tr><th>Name</th><th>Position</th><th>Active Nights</th><th>Edit</th><th>Delete</th></tr></thead>';
        echo '<tbody>';
        foreach ($players as $player) {
 	    // Generate a nonce for the delete link
            $delete_nonce = wp_create_nonce('hockeysignin_delete_player_' . $player->id);

   	    echo "<tr>
                    <td>{$player->name}</td>
            	    <td>{$player->position}</td>
            	    <td>{$player->active_nights}</td>
            	    <td><a href='?page=hockeysignin&edit={$player->id}' class='button'>Edit</a></td>
            	    <td><a href='?page=hockeysignin&delete={$player->id}&_wpnonce={$delete_nonce}' class='button'>Delete</a></td>
                  </tr>";
}
        echo '</tbody></table>';
    } else {
        echo '<p>No players found.</p>';
    }   
    echo '</div>'; // Close the .wrap div here
}
